<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Bighorn Event Tracking</title>
  <link rel="stylesheet" href="https://code.jquery.com/qunit/qunit-1.23.1.css">
</head>
<body>
  <div id="qunit"></div>
  <div id="qunit-fixture"></div>
  <script src="https://code.jquery.com/qunit/qunit-1.23.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.11.2/lodash.min.js"></script>
  <script type="text/javascript" src="../dist/bighorn.js"></script>
  <script>
    Bighorn.debug = true;

    QUnit.module( "Bighorn", {
      beforeEach: function() {
        delete self._gaq;
        delete self._paq;
        delete self.ahoy;
        delete self.ga;
      }
    });

    function ahoyMock() {
      var Mock = function () {
        this.track = function(name, eventData) {
          this.name = name;
          this.eventData = eventData;
        };
      };
      return new Mock();
    }

    function aqMock() {
      var Mock = function () {
        this.push = function(list) {
          this.list = list;
        };
      };
      return new Mock();
    }

    function gaMock(data) {
      return function (method, type, category, action, label, value) {
        data.method = method;
        data.type = type;
        data.category = category;
        data.action = action;
        data.label = label;
        data.value = value;
      };
    }

    function validEventData() {
      return {
        name: "example-event",
        type: "test",
        host: self.location.hostname + self.location.pathname,
        target: self.location.hostname + self.location.pathname,
        value: 0.25,
        utm_source: "bighorn-test-suite"
      }
    }

    QUnit.test( "should return a valid result when tracking with no args", function(assert) {
      var result = Bighorn.track();
      assert.ok( result, "result should be an object" );
      assert.ok( result.trackers, "result.trackers should be an object" );
      assert.ok( result.trackers._gaq === false, "_gaq should be false" );
      assert.ok( result.trackers._paq === false, "_paq should be false" );
      assert.ok( result.trackers.ahoy === false, "ahoy should be false" );
      assert.ok( result.trackers.ga === false, "ga should be false" );
    });

    QUnit.test( "should return a valid result when tracking with empty event data", function(assert) {
      var result = Bighorn.track({});
      assert.ok( result, "result should be an object" );
      assert.ok( result.trackers, "result.trackers should be an object" );
      assert.ok( result.trackers._gaq === false, "_gaq should be false" );
      assert.ok( result.trackers._paq === false, "_paq should be false" );
      assert.ok( result.trackers.ahoy === false, "ahoy should be false" );
      assert.ok( result.trackers.ga === false, "ga should be false" );
    });

    QUnit.test( "should attach validation errors when tracking with empty event data", function(assert) {
      var result = Bighorn.track({});
      assert.ok( result.event_data.validation_errors, "validation errors should be present" );
      assert.ok( result.event_data.validation_errors.length === 6, "6 validation errors should be present" );
    });

    QUnit.test( "should track with ahoy with partial event data", function(assert) {
      self.ahoy = ahoyMock();

      var event = { name: "test" };
      var result = Bighorn.track(event);
      assert.ok( result.trackers.ahoy, "ahoy should be true even though validation errors are present" );
      assert.ok( result.event_data.validation_errors.length === 5, "5 validation errors should be present" );
    });

    QUnit.test( "should track with ahoy with valid event data", function(assert) {
      self.ahoy = ahoyMock();

      var eventData = validEventData();
      var result = Bighorn.track(eventData);
      assert.ok( result.trackers.ahoy, "ahoy should be true" );
      assert.ok( result.event_data.validation_errors.length === 0, "no errors should be present" );
      assert.ok( self.ahoy.name === eventData.name );
      assert.ok( _.isObject(self.ahoy.eventData) );
      assert.ok( self.ahoy.eventData.name === eventData.name );
      assert.ok( self.ahoy.eventData.type === eventData.type );
      assert.ok( self.ahoy.eventData.host === eventData.host );
      assert.ok( self.ahoy.eventData.target === eventData.target );
      assert.ok( self.ahoy.eventData.value === eventData.value );
      assert.ok( self.ahoy.eventData.utm_source === eventData.utm_source );
    });

    QUnit.test( "should track with _paq with partial event data", function(assert) {
      self._paq = aqMock();

      var event = { name: "test" };
      var result = Bighorn.track(event);
      assert.ok( result.trackers._paq, "_paq should be true even though validation errors are present" );
      assert.ok( result.event_data.validation_errors.length === 5, "5 validation errors should be present" );
    });

    QUnit.test( "should track with _paq with valid event data", function(assert) {
      self._paq = aqMock();

      var eventData = validEventData();
      var result = Bighorn.track(eventData);
      assert.ok( result.trackers._paq, "_paq should be true" );
      assert.ok( result.event_data.validation_errors.length === 0, "no errors should be present" );
      assert.ok( self._paq.list[0] === "trackEvent" );
      assert.ok( self._paq.list[1] === Bighorn.kvn({ target: eventData.target }) );
      assert.ok( self._paq.list[2] === Bighorn.kvn(eventData) );
      assert.ok( self._paq.list[3] === Bighorn.kvn({ name: eventData.name }) );
      assert.ok( self._paq.list[4] === eventData.value );
    });

    QUnit.test( "should track with _gaq with partial event data", function(assert) {
      self._gaq = aqMock();

      var event = { name: "test" };
      var result = Bighorn.track(event);
      assert.ok( result.trackers._gaq, "_gaq should be true even though validation errors are present" );
      assert.ok( result.event_data.validation_errors.length === 5, "5 validation errors should be present" );
    });

    QUnit.test( "should track with _gaq with valid event data", function(assert) {
      self._gaq = aqMock();

      var eventData = validEventData();
      var result = Bighorn.track(eventData);
      assert.ok( result.trackers._gaq, "_gaq should be true" );
      assert.ok( result.event_data.validation_errors.length === 0, "no errors should be present" );
      assert.ok( self._gaq.list[0] === "trackEvent" );
      assert.ok( self._gaq.list[1] === Bighorn.kvn({ target: eventData.target }) );
      assert.ok( self._gaq.list[2] === Bighorn.kvn(eventData) );
      assert.ok( self._gaq.list[3] === Bighorn.kvn({ name: eventData.name }) );
      assert.ok( self._gaq.list[4] === eventData.value );
    });

    QUnit.test( "should track with ga with partial event data", function(assert) {
      self.ga = gaMock({});

      var event = { name: "test" };
      var result = Bighorn.track(event);
      assert.ok( result.trackers.ga, "ga should be true even though validation errors are present" );
      assert.ok( result.event_data.validation_errors.length === 5, "5 validation errors should be present" );
    });

    QUnit.test( "should track with ga with valid event data", function(assert) {
      var data = {};
      self.ga = gaMock(data);

      var eventData = validEventData();
      var result = Bighorn.track(eventData);
      assert.ok( result.trackers.ga, "ga should be true" );
      assert.ok( result.event_data.validation_errors.length === 0, "no errors should be present" );
      assert.ok( data.method === "send" );
      assert.ok( data.type === "event" );
      assert.ok( data.category === Bighorn.kvn({ target: eventData.target }) );
      assert.ok( data.action === Bighorn.kvn(eventData) );
      assert.ok( data.label === Bighorn.kvn({ name: eventData.name }) );
      assert.ok( data.value === eventData.value );
    });
  </script>
</body>
</html>
